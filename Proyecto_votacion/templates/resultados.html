{% extends 'partials/base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}Resultados de Votaci√≥n{% endblock %}

{% block content %}

<header class="mb-5">
    <h1 class="text-center font-weight-bold display-4 mb-3 ">Resultados Electorales</h1>
    <h2 class="text-center font-weight-normal h3">{{ proceso.nombre }}</h2>
    <div class="mt-4">
        <h3 class="text-left text-dark mb-2">üë• Total de Electores: <strong>{{ total_sufragantes_registrados }}</strong></h3>
        <h3 class="text-left text-dark mb-2">üó≥Ô∏è Total de Sufragantes: <strong>{{ total_sufragantes }}</strong></h3>
        <h3 class="text-left text-dark">üìà Participaci√≥n: <strong>{{ porcentaje_participacion }}%</strong></h3>
    </div>
</header>

<section class="mb-5">
    <div class="row align-items-stretch">
        <!-- Tabla de resultados -->
        <div class="col-md-6 mb-4 d-flex">
            <div class="card border-primary shadow-sm flex-fill">
                <div class="card-header bg-primary text-white text-center">
                    <h3 class="mb-0">Resultados Totales</h3>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0" style="font-size: 1.3rem;">
                        <thead class="bg-primary text-white">
                            <tr>
                                <th scope="col" class="text-center">Candidato</th>
                                <th scope="col" class="text-center">Votos</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for candidato, votos in resultados.items %}
                            <tr>
                                <td class="text-center font-weight-bold">{{ candidato.nombre }}</td>
                                <td class="text-center font-weight-bold">{{ votos }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Gr√°fico -->
        <div class="col-md-6 mb-4 d-flex">
            <div class="card border-primary shadow-sm flex-fill">
                <div class="card-header bg-primary text-white text-center">
                    <h3 class="mb-0">Gr√°fico de Resultados</h3>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <div id="votacion-chart" class="ct-chart w-100" style="height: 450px;"></div>
                </div>
            </div>
        </div>
    </div>
</section>

<div class="text-center mb-5">
    <form action="{% url 'reiniciar_votacion' proceso.id %}" method="post">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger btn-lg">Encerar la Base de Datos</button>
    </form>
</div>

{% endblock %}

{% block extra_css %}
<link href="{% static 'libs/chartist/dist/chartist.min.css' %}" rel="stylesheet">
<style>
    body {
        background-color: #f8f9fa;
        font-family: 'Roboto', sans-serif;
    }

    .card {
        border-radius: 10px;
    }

    .card-header {
        font-size: 1.6rem;
        font-weight: bold;
    }

    .table th, .table td {
        vertical-align: middle;
        padding: 15px;
    }

    .table th {
        font-size: 1.3rem;
    }

    .ct-chart {
        height: 450px;
    }

    .ct-label {
        color: #000;
        font-weight: bold;
        font-size: 1.3rem;
    }

    .ct-grid {
        stroke: rgba(0, 0, 0, 0.1);
    }

    .ct-bar {
        stroke-width: 45px;
    }

    .btn-danger {
        padding: 15px 50px;
        font-size: 1.5em;
        border-radius: 30px;
    }

    @media (max-width: 768px) {
        .ct-chart {
            height: 300px;
        }
        .ct-label {
            font-size: 1rem;
        }
    }
</style>
{% endblock %}

{% block extra_javascript %}
<script src="{% static 'libs/chartist/dist/chartist.min.js' %}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var data = {
            labels: [
                {% for candidato, votos in resultados.items %}
                '{{ candidato.nombre }}'{% if not forloop.last %}, {% endif %}{% endfor %}
            ],
            series: [[
                {% for candidato, votos in resultados.items %}
                {{ votos }}{% if not forloop.last %}, {% endif %}{% endfor %}
            ]]
        };

        var options = {
            high: Math.max({{ total_sufragantes }}, 10),
            axisX: {
                offset: 60,
                showGrid: false,
                labelInterpolationFnc: function(value) {
                    return value.length > 20 ? value.slice(0, 20) + '...' : value;
                }
            },
            axisY: {
                onlyInteger: true,
                offset: 70,
                labelInterpolationFnc: function(value) {
                    return value.toFixed(0);
                }
            },
            seriesBarDistance: 35,
            chartPadding: { top: 30, right: 20, bottom: 20, left: 20 }
        };

        var responsiveOptions = [
            ['screen and (max-width: 768px)', {
                seriesBarDistance: 20,
                axisX: {
                    labelInterpolationFnc: function(value) {
                        return value.split(' ')[0];
                    }
                }
            }]
        ];

        var chart = new Chartist.Bar('#votacion-chart', data, options, responsiveOptions);

        // Colores distintos para cada candidato
        chart.on('draw', function(ctx) {
            if(ctx.type === 'bar') {
                var colors = [
                    '#007bff', // azul
                    '#28a745', // verde
                    '#dc3545', // rojo
                    '#ffc107', // amarillo
                    '#6f42c1', // morado
                    '#20c997', // turquesa
                    '#fd7e14'  // naranja
                ];
                ctx.element.attr({
                    style: 'stroke: ' + colors[ctx.index % colors.length] + '; stroke-width: 45px;'
                });
            }
        });
    });
</script>
{% endblock %}
