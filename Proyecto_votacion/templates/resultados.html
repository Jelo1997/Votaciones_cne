{% extends 'partials/base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}Resultados de Votación{% endblock %}

{% block content %}

<header class="text-center mb-4">
    <img src="{% static 'images/elecciones.jpg' %}" alt="Logo CNE" class="mb-3" style="width: 120px;">
    <h1>Unidad Provincial de Seguridad Informática y Proyectos Tecnológicos Electorales de Pastaza</h1>
    <h2>{{ proceso.nombre }}</h2>
    <h3 class="mb-4 text-muted">Total de Sufragantes: <strong>{{ total_sufragantes }}</strong></h3>
</header>

<section class="mb-5">
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Resultados Totales</h4>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th scope="col" class="text-center">Candidato</th>
                                <th scope="col" class="text-center">Votos</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for candidato, votos in resultados.items %}
                            <tr>
                                <td class="text-center">{{ candidato.nombre }}</td>
                                <td class="text-center">{{ votos }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Gráfico de Resultados</h4>
                </div>
                <div class="card-body">
                    <div id="votacion-chart" class="ct-chart" style="height: 450px; padding: 20px;"></div>
                </div>
            </div>
        </div>
    </div>
</section>

<div class="text-center">
    <form action="{% url 'reiniciar_votacion' proceso.id %}" method="post">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger btn-lg">Encerrar la Base de Datos</button>
    </form>
</div>

{% endblock %}

{% block extra_css %}
<link href="{% static 'libs/chartist/dist/chartist.min.css' %}" rel="stylesheet">
<style>
    .container-fluid {
        padding: 40px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    h1, h2, h3 {
        color: #333; /* Color más oscuro para los encabezados */
    }
    h3 {
        text-align: left;
    }
    table {
        margin-bottom: 30px;
        border-radius: 5px;
        overflow: hidden;
    }
    .table th, .table td {
        text-align: center;
        vertical-align: middle;
        padding: 15px; 
        border: 1px solid #dee2e6; /* Borde más suave */
        color: #333; /* Texto más oscuro en la tabla */
    }
    .table-striped tbody tr:nth-of-type(odd) {
        background-color: #f8f9fa; /* Color más claro */
    }
    .btn-danger {
        padding: 12px 45px;
        font-size: 1.2em;
    }
    header img {
        margin-bottom: 15px;
    }
    .ct-chart {
        height: 450px; /* Altura aumentada */
        width: 100%; 
    }
    .ct-series .ct-bar {
        stroke-width: 40px; /* Aumentar el grosor de las barras */
    }
    .ct-label {
        color: #000; /* Color de las etiquetas del gráfico más oscuro */
        font-weight: bold; /* Negrita para mayor claridad */
    }
</style>
{% endblock %}

{% block extra_javascript %}
<script src="{% static 'libs/chartist/dist/chartist.min.js' %}"></script>
<script src="{% static 'libs/chartist-plugin-tooltips/dist/chartist-plugin-tooltip.min.js' %}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var data = {
            labels: [
                {% for candidato, votos in resultados.items %}
                '{{ candidato.nombre }}'{% if not forloop.last %}, {% endif %}{% endfor %},
            ],
            series: [[
                {% for candidato, votos in resultados.items %}
                {{ votos }}{% if not forloop.last %}, {% endif %}{% endfor %},
                {{ votos_blanco }}, {{ votos_nulo }}
            ]]
        };

        var options = {
            high: Math.max({{ total_sufragantes }}, 350),
            plugins: [Chartist.plugins.tooltip()],
            axisX: {
                offset: 30,
                labelInterpolationFnc: function(value, index) {
                    return value.length > 10 ? value.slice(0, 10) + '...' : value;
                },
                labelOffset: { x: 0, y: 10 }, // Espaciado de las etiquetas
            },
            axisY: {
                offset: 40,
                onlyInteger: true
            },
            seriesBarDistance: 15,
            chartPadding: {
                left: 20,
                right: 20,
                top: 20,
                bottom: 20
            }
        };

        var responsiveOptions = [
            ['screen and (max-width: 640px)', {
                seriesBarDistance: 5,
                axisX: {
                    labelInterpolationFnc: function(value) {
                        return value.split(' ').slice(0, 1).join(' ');
                    }
                }
            }]
        ];

        new Chartist.Bar('#votacion-chart', data, options, responsiveOptions);

        // Personalizar colores de las barras
        data.series[0].forEach((value, index) => {
            let color;
            if (index < {{ resultados|length }}) {
                color = '#007bff'; // Color para candidatos
            } else if (index === {{ resultados|length }}) {
                color = '#28a745'; // Color para votos en blanco
            } else {
                color = '#dc3545'; // Color para votos nulos
            }
            document.querySelector(`#votacion-chart .ct-bar.ct-bar-${index}`).style.fill = color;
        });
    });
</script>
{% endblock %}
